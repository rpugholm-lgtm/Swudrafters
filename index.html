<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWU: Ultimate Drafter (Safe Mode)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --accent: #FFE81F; --text-main: #e0e0e0;
            --c-leader: #eee; --c-base: #888; --c-unit: #444; --c-pool: #553333; 
            --c-Vigilance: #0055aa; --c-Command: #00aa00; --c-Aggression: #aa0000;
            --c-Cunning: #aa8800; --c-Villainy: #222; --c-Heroism: #ddd; --success-green: #0a0;
        }
        body { background: var(--bg); color: var(--text-main); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px 20px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; height: 50px; z-index: 10; }
        h1 { margin: 0; font-family: 'Orbitron'; color: var(--accent); font-size: 18px; letter-spacing: 1px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        select, input { background: #111; color: var(--accent); border: 1px solid #444; padding: 5px 10px; font-family: 'Orbitron'; font-size: 14px; border-radius: 4px; }
        input { width: 50px; text-align: center; }
        button.btn { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; font-family: 'Orbitron'; cursor: pointer; transition: 0.2s; border-radius: 4px; font-size: 12px; text-transform: uppercase; }
        button.btn:hover { border-color: var(--accent); color: var(--accent); background: #000; }
        button.btn:disabled { color: #555; border-color: #333; cursor: wait; opacity: 0.7; }
        button.btn-pew { background: #822; border-color: #a44; color: #fff; font-weight: bold; }
        button.btn-pew:hover { background: #b33; border-color: #f66; color: #fff; transform: scale(1.1); }
        #data-status { font-size: 10px; color: #777; margin-left: 10px; font-family: monospace; }
        .status-ok { color: var(--success-green) !important; } .status-error { color: #f55 !important; }
        .status-loading { color: var(--accent) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .stat { font-family: 'Orbitron'; font-size: 14px; color: #aaa; margin-right: 20px; } .stat span { color: var(--accent); }
        #main-area { display: flex; flex: 1; overflow: hidden; }
        #board { flex: 1; display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: url('https://swudb.com/images/background.jpg') center/cover fixed no-repeat; align-items: flex-start; }
        #board::before { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: -1; pointer-events: none; }
        .column { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; transition: all 0.2s; flex-shrink: 0; height: 100%; min-width: 150px; width: 150px; }
        .column.drag-over { background: rgba(60, 60, 60, 0.95); box-shadow: 0 0 25px var(--accent); border-color: var(--accent); }
        .col-special { width: 170px; min-width: 170px; border: 1px solid #555; }
        .col-pool { width: 450px; min-width: 450px; border: 1px solid #644; background: rgba(30, 20, 20, 0.9); }
        .col-header { padding: 8px; text-align: center; font-family: 'Orbitron'; font-weight: bold; font-size: 16px; border-bottom: 4px solid transparent; text-transform: uppercase; background: rgba(0,0,0,0.6); border-top-left-radius: 8px; border-top-right-radius: 8px; z-index: 5; }
        .ch-Leader { border-bottom-color: var(--c-leader); color: var(--c-leader); } .ch-Base { border-bottom-color: var(--c-base); color: var(--c-base); } .ch-Pool { border-bottom-color: var(--c-pool); color: #faa; } .ch-cost { border-bottom-color: var(--c-unit); color: #fff; font-size: 20px; }
        .ch-Aggression { border-bottom-color: var(--c-Aggression); color: #ff6666; } .ch-Command { border-bottom-color: var(--c-Command); color: #66ff66; } .ch-Cunning { border-bottom-color: var(--c-Cunning); color: #ffee66; } .ch-Vigilance { border-bottom-color: var(--c-Vigilance); color: #66bbff; } .ch-Villainy { border-bottom-color: var(--c-Villainy); color: #999; } .ch-Heroism { border-bottom-color: var(--c-Heroism); color: #fff; }
        .col-content { flex: 1; overflow-y: auto; overflow-x: visible; padding: 15px 10px 50px 10px; display: flex; flex-direction: column; align-items: center; }
        #list-Pool { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; align-content: start; align-items: start; }
        #sidebar { width: 280px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 100; transition: all 0.2s; position: relative; flex-shrink: 0; }
        #sidebar.drag-over-deck { background: #1a1a1a; box-shadow: inset 0 0 20px var(--success-green); border-left: 2px solid var(--success-green); }
        #sidebar.drag-over-deck::after { content: 'SLIP FOR AT TILFØJE'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--success-green); font-family: 'Orbitron'; font-weight: bold; width: 100%; text-align: center; pointer-events: none; }
        .sb-header { padding: 15px; background: #181818; border-bottom: 1px solid #333; font-family: 'Orbitron'; color: var(--accent); }
        #deck-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        #deck-list li { background: #222; padding: 6px 10px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; font-size: 13px; border-radius: 3px; cursor: pointer; transition: background 0.2s; }
        #deck-list li:hover { background: #444; color: #fff; }
        .sb-footer { padding: 10px; border-top: 1px solid #333; background: #181818; }
        .card-item { position: relative; background: #000; border-radius: 6px; cursor: grab; box-shadow: 0 -2px 5px rgba(0,0,0,0.5); transition: transform 0.1s ease-out, margin 0.2s; display: flex; flex-direction: column; width: 100%; z-index: 1; }
        .col-content:not(#list-Pool):not(#list-Leader):not(#list-Base) .card-item:not(:first-child) { margin-top: -135px; }
        #list-Pool .card-item, #list-Leader .card-item, #list-Base .card-item { margin-top: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.6); }
        .card-item:hover { transform: scale(1.35) translateY(-10px); z-index: 1000 !important; box-shadow: 0 10px 30px rgba(0,0,0,0.9); border: 1px solid var(--accent); }
        .card-item img { width: 100%; height: auto; display: block; border-radius: 6px; pointer-events: none; }
        .card-actions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; border-radius: 6px; }
        .card-item:hover .card-actions { display: flex; }
        .add-icon { font-size: 24px; color: #fff; font-weight: bold; text-shadow: 0 0 10px #000; pointer-events: none; background: rgba(0,0,0,0.6); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; }
        .stack-badge { position: absolute; top: 5px; right: 5px; background: var(--accent); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: 900; border: 2px solid #000; z-index: 5; box-shadow: 2px 2px 5px #000; }
        #preview-tooltip { position: fixed; display: none; z-index: 5000; pointer-events: none; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; }
        #preview-tooltip img { width: 320px; display: block; border-radius: 6px; }
        #preview-tooltip.big-preview img { width: auto; height: 60vh; max-width: none; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
        .modal-card-container { position: relative; margin-bottom: 20px; cursor: pointer; }
        .modal-card-container:hover::after { content: '↻'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; color: rgba(255, 255, 255, 0.7); text-shadow: 0 0 20px #000; pointer-events: none; }
        #modal img { max-width:90vw; max-height:70vh; border-radius: 10px; display: block; box-shadow: 0 0 50px #000; border: 2px solid #333; }
        .big-flip-btn { background: var(--accent); color: #000; font-family: 'Orbitron'; font-size: 24px; font-weight: 900; padding: 15px 40px; border: 3px solid #000; border-radius: 8px; cursor: pointer; box-shadow: 0 0 20px var(--accent); animation: pulse 2s infinite; display: none; }
        .big-flip-btn:hover { background: #fff; transform: scale(1.05); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 232, 31, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 232, 31, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 232, 31, 0); } }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-family: 'Orbitron'; border: 1px solid var(--accent); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>
    <header>
        <div class="controls">
            <h1>SWU Drafter</h1>
            <select id="setSelect" onchange="clearCache()">
                <option value="TWI">Twilight of the Republic (TWI)</option>
                <option value="JTL">Jump to Lightspeed (JTL)</option>
                <option value="LOF">Legends of the Force (LOF)</option>
                <option value="SEC">Secrets of Power (SEC)</option>
                <option value="SOR">Spark of Rebellion (SOR)</option>
                <option value="SHD">Shadows of the Galaxy (SHD)</option>
            </select>
            <span id="data-status"></span>
            <label style="color:#aaa; font-size:12px; margin-left:10px;">Pakker:</label>
            <input type="number" id="packCount" value="6" min="1" max="24">
            <button class="btn" id="btn-open" onclick="openPacks()">ÅBN</button>
            <button class="btn" id="btn-toggle-lb" onclick="toggleLeadersBases()">Skjul L/B</button>
            <button class="btn" id="btn-sort" onclick="toggleSort()">Sorter: Cost</button>
            <button class="btn btn-pew" onclick="playAudio('snd-pew')">PEW PEW!</button>
        </div>
        <div id="stats"><span class="stat">Pool: <span id="s-total">0</span></span></div>
    </header>

    <div id="main-area">
        <div id="board"></div>
        <div id="sidebar">
            <div class="sb-header">Dit Deck (<span id="deck-count">0</span>)</div>
            <ul id="deck-list"></ul>
            <div class="sb-footer">
                <button class="btn" style="width:100%" onclick="copyJSON()">Kopiér JSON</button>
                <button class="btn" style="width:100%; margin-top:5px; background:#4a1a1a; border-color:#6a2a2a;" onclick="clearDeck()">Slet Deck</button>
                <button class="btn" style="width:100%; margin-top:5px; font-size:10px; background:#222;" onclick="clearCache()">Reset Data</button>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-card-container" onclick="flipLeader(event)">
            <img id="modal-img">
        </div>
        <button id="modal-flip-btn" class="big-flip-btn" onclick="flipLeader(event)">VEND LEADER ↻</button>
    </div>

    <div id="preview-tooltip"></div>
    <div id="toast">Udført</div>
    <audio id="snd-cantina" src="https://www.myinstants.com/media/sounds/cantina-band-star-wars.mp3" preload="auto"></audio>
    <audio id="snd-pew" src="https://www.myinstants.com/media/sounds/pew-pew-pew-pew-pew.mp3" preload="auto"></audio>
    <audio id="snd-copy" src="https://www.myinstants.com/media/sounds/lightsaber-turn-on.mp3" preload="auto"></audio>

<script>
const COST_COLS = ["1", "2", "3", "4", "5", "6", "7", "8"];
const ASPECT_COLS = ["Aggression", "Command", "Cunning", "Vigilance", "Villainy", "Heroism"];
let myDeck = {}, currentView = [], areSpecialColsVisible = true, currentSortMode = 'cost', CARD_DATABASE = {};

// --- API HELPERS ---
function mapApiType(cardData) {
    if (!cardData.Type) return "Unit";
    const t = cardData.Type.toLowerCase();
    if (t.includes("leader")) return "Leader";
    if (t.includes("base")) return "Base";
    return "Unit";
}
function mapApiAspect(cardData) {
    const aspects = cardData.Aspects || [];
    const mainColors = ["Aggression", "Command", "Cunning", "Vigilance"];
    for (let a of aspects) if (mainColors.includes(a)) return a;
    return aspects.length > 0 ? aspects[0] : "Villainy";
}

// --- ROBUST FETCH ---
async function fetchSetData(setCode) {
    const statusEl = document.getElementById('data-status');
    if (CARD_DATABASE[setCode]) return CARD_DATABASE[setCode];

    statusEl.innerText = "Henter data...";
    statusEl.className = "status-loading";

    try {
        // Vi bruger Promise.race til at timeout hvis API hænger
        const fetchWithTimeout = (url, ms) => Promise.race([
            fetch(url),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), ms))
        ]);

        // Forsøg AllOrigins Proxy (Mest stabil til GitHub Pages)
        const targetUrl = `https://api.swu-db.com/cards/search?q=set:${setCode.toLowerCase()}&pretty=false`;
        const res = await fetchWithTimeout(`https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`, 3000); // 3 sek timeout

        if (!res.ok) throw new Error("Proxy failed");
        const data = await res.json();
        if (!data || data.length === 0) throw new Error("No data");

        const processedSet = { leaders: [], bases: [], deck: [] };
        data.forEach(card => {
            const idFormatted = card.Number.toString().padStart(3, '0');
            const type = mapApiType(card);
            let frontImg = card.FrontArt || `https://swudb.com/images/cards/${setCode}/${idFormatted}.png`;
            let backImg = card.BackArt || `https://swudb.com/images/cards/${setCode}/${idFormatted}-back.png`;
            if(type === 'Leader' && !card.BackArt) backImg = `https://swudb.com/images/cards/${setCode}/${idFormatted}-back.png`;

            const c = {
                id: idFormatted, set: setCode, name: card.Name, type: type,
                cost: (card.Cost != null) ? card.Cost.toString() : "0",
                aspect: mapApiAspect(card), img: frontImg, back: backImg
            };
            if (type === 'Leader') processedSet.leaders.push(c);
            else if (type === 'Base') processedSet.bases.push(c);
            else processedSet.deck.push(c);
        });

        CARD_DATABASE[setCode] = processedSet;
        statusEl.innerText = "Online Mode"; statusEl.className = "status-ok";
        return processedSet;

    } catch (err) {
        console.warn("API Fejl:", err);
        statusEl.innerText = "Offline Mode"; statusEl.className = "status-error";
        return null; // Trigger fallback
    }
}

function generateFallbackSet(setCode) {
    const dummySet = { leaders: [], bases: [], deck: [] };
    const aspects = ["Aggression", "Command", "Cunning", "Vigilance"];
    for(let i=1; i<=252; i++) {
        const id = i.toString().padStart(3, '0');
        let type = "Unit";
        if (i <= 18) type = "Leader"; else if (i <= 30) type = "Base";
        const c = {
            id: id, set: setCode, name: `${setCode} #${id}`, type: type,
            cost: ((i%8)+1).toString(), aspect: aspects[i%4],
            img: `https://swudb.com/images/cards/${setCode}/${id}.png`,
            back: `https://swudb.com/images/cards/${setCode}/${id}-back.png`
        };
        if (type==='Leader') dummySet.leaders.push(c);
        else if (type==='Base') dummySet.bases.push(c);
        else dummySet.deck.push(c);
    }
    return dummySet;
}

async function openPacks() {
    const btn = document.getElementById('btn-open');
    const setCode = document.getElementById('setSelect').value;
    const packCount = parseInt(document.getElementById('packCount').value) || 6;
    
    btn.disabled = true;
    playAudio('snd-cantina');

    let setData = await fetchSetData(setCode);
    if (!setData || setData.deck.length === 0) setData = generateFallbackSet(setCode);

    currentView = [];
    for(let i=0; i<packCount; i++) {
        if(setData.leaders.length) currentView.push({...setData.leaders[Math.floor(Math.random()*setData.leaders.length)], uid:Date.now()+i+'l', column:'Leader'});
        if(setData.bases.length) currentView.push({...setData.bases[Math.floor(Math.random()*setData.bases.length)], uid:Date.now()+i+'b', column:'Base'});
        for(let k=0; k<14; k++) {
            if(setData.deck.length) {
                const c = setData.deck[Math.floor(Math.random()*setData.deck.length)];
                let col = (currentSortMode === 'cost') ? ((parseInt(c.cost) > 8) ? "8" : c.cost) : c.aspect;
                currentView.push({...c, uid:Date.now()+i+k+'d', column:col});
            }
        }
    }
    renderBoard();
    btn.disabled = false;
}

// --- CORE FUNCTIONS ---
function initBoard() {
    const board = document.getElementById('board'); board.innerHTML = '';
    let activeCols = (currentSortMode === 'cost') ? ["Leader", "Base", "Pool", ...COST_COLS] : ["Leader", "Base", "Pool", ...ASPECT_COLS];
    activeCols.forEach(colName => {
        const col = document.createElement('div'); col.id = `col-${colName}`;
        let cssClass = 'column';
        if (colName === "Leader" || colName === "Base") cssClass += ' col-special';
        if (colName === "Pool") cssClass += ' col-pool';
        col.className = cssClass;
        col.ondragover = (e) => e.preventDefault();
        col.ondrop = (e) => handleDropOnBoard(e, colName);

        let headerClass = "ch-cost";
        if (colName === "Leader") headerClass = "ch-Leader";
        else if (colName === "Base") headerClass = "ch-Base";
        else if (ASPECT_COLS.includes(colName)) headerClass = `ch-${colName}`;

        col.innerHTML = `<div class="col-header ${headerClass}">${colName}</div><div class="col-content" id="list-${colName}"></div>`;
        board.appendChild(col);
    });
    toggleLeadersBases(true);
}

function renderBoard() {
    const allCols = ["Leader", "Base", "Pool", ...COST_COLS, ...ASPECT_COLS];
    allCols.forEach(c => { const el = document.getElementById(`list-${c}`); if(el) el.innerHTML = ''; });

    const map = {};
    currentView.forEach(c => {
        let target = c.column;
        if (c.type !== 'Leader' && c.type !== 'Base') {
             if (currentSortMode === 'cost') target = (parseInt(c.cost)>8)?"8":c.cost;
             else target = c.aspect;
        }
        c.column = target;
        const key = `${c.id}_${c.column}`;
        if(map[key]) map[key].count++; else map[key] = {...c, count:1};
    });

    document.getElementById('s-total').innerText = currentView.length;
    Object.values(map).forEach(c => {
        const target = document.getElementById(`list-${c.column}`) || document.getElementById('list-Pool');
        if(!target) return;
        const cardEl = document.createElement('div'); cardEl.className = `card-item`; cardEl.draggable = true;
        cardEl.ondragstart = (e) => { const payload = JSON.stringify({id: c.id, set: c.set}); e.dataTransfer.setData("text/plain", payload); };
        cardEl.onclick = (e) => { if(e.target.tagName !== 'DIV') openModal(c); };
        cardEl.onmouseenter = (e) => showPreview(e, c.img, c.type); 
        cardEl.onmouseleave = hidePreview; cardEl.onmousemove = (e) => movePreview(e);
        const stackHtml = c.count > 1 ? `<div class="stack-badge">${c.count}</div>` : '';
        cardEl.innerHTML = `${stackHtml}<img src="${c.img}" draggable="false"><div class="card-actions" onclick="addToDeck('${c.id}', '${c.set}')"><div class="add-icon">+</div></div>`;
        target.appendChild(cardEl);
    });
}

function toggleSort() {
    const btn = document.getElementById('btn-sort');
    currentSortMode = (currentSortMode === 'cost') ? 'aspect' : 'cost';
    btn.innerText = `Sorter: ${currentSortMode === 'cost' ? 'Cost' : 'Aspect'}`;
    initBoard(); renderBoard();
}

function toggleLeadersBases(maintain) {
    if(!maintain) areSpecialColsVisible = !areSpecialColsVisible;
    const display = areSpecialColsVisible ? 'flex' : 'none';
    if(document.getElementById('col-Leader')) document.getElementById('col-Leader').style.display = display;
    if(document.getElementById('col-Base')) document.getElementById('col-Base').style.display = display;
    document.getElementById('btn-toggle-lb').innerText = areSpecialColsVisible ? "Skjul L/B" : "Vis L/B";
}

function addToDeck(id, setCode) {
    const idx = currentView.findIndex(c => c.id === id && c.set === setCode);
    if (idx === -1) return;
    const card = currentView[idx]; currentView.splice(idx, 1); 
    const key = `${card.set}_${card.id}`;
    if(myDeck[key]) myDeck[key].count++; else myDeck[key] = { ...card, count: 1 }; 
    renderBoard(); updateSidebar();
}

function removeFromDeck(key) {
    if(!myDeck[key]) return;
    const card = myDeck[key]; card.count--;
    if(card.count <= 0) delete myDeck[key];
    currentView.push({ ...card, count: undefined, uid: Date.now() });
    renderBoard(); updateSidebar();
}

function updateSidebar() {
    const ul = document.getElementById('deck-list'); ul.innerHTML = '';
    let sum = 0;
    Object.values(myDeck).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
        sum += c.count;
        const li = document.createElement('li');
        li.style.borderLeftColor = `var(--c-${c.type === 'Leader' ? 'leader' : c.type === 'Base' ? 'base' : 'unit'})`;
        li.innerHTML = `<span>${c.name}</span> <span style="color:var(--accent); font-weight:bold;">${c.count}</span>`;
        li.onclick = () => removeFromDeck(`${c.set}_${c.id}`);
        li.onmouseenter = (e) => showPreview(e, c.img, c.type);
        li.onmouseleave = hidePreview; li.onmousemove = (e) => movePreview(e);
        ul.appendChild(li);
    });
    document.getElementById('deck-count').innerText = sum;
}

function clearDeck() { Object.values(myDeck).forEach(c => { for(let i=0; i<c.count; i++) currentView.push({...c, count:undefined}); }); myDeck={}; renderBoard(); updateSidebar(); }
function clearCache() { CARD_DATABASE = {}; alert("Data nulstillet"); }
function playAudio(id) { const s=document.getElementById(id); if(s){s.volume=0.4; s.currentTime=0; s.play().catch(e=>{});} }
function handleDropOnBoard(e) { e.preventDefault(); } // Auto-sort only
function handleDropOnDeck(e) { e.preventDefault(); try{const d=JSON.parse(e.dataTransfer.getData("text/plain")); if(d.id) addToDeck(d.id, d.set);}catch(e){} document.getElementById('sidebar').classList.remove('drag-over-deck'); }

const tooltip = document.getElementById('preview-tooltip');
function showPreview(e, src, type) {
    tooltip.innerHTML = `<img src="${src}">`;
    tooltip.className = (type==='Leader'||type==='Base') ? 'big-preview' : '';
    tooltip.style.display = 'block'; movePreview(e);
}
function movePreview(e) {
    const w=window.innerWidth; let x=e.clientX+20, y=e.clientY+10;
    if(x+(tooltip.className?600:320)>w) x=e.clientX-(tooltip.className?600:320)-20;
    const winH = window.innerHeight; const h = tooltip.offsetHeight || 400;
    if(y+h > winH) y = winH - h - 20;
    tooltip.style.top=y+'px'; tooltip.style.left=x+'px';
}
function hidePreview(){tooltip.style.display='none';}

const modal = document.getElementById('modal');
const modalImg = document.getElementById('modal-img');
const modalFlipBtn = document.getElementById('modal-flip-btn');
let currentZoomCard = null;
function openModal(c) {
    currentZoomCard=c; modal.style.display='flex';
    if(c.type==='Leader') { modalImg.src=c.img; modalFlipBtn.style.display='block'; }
    else { modalImg.src=c.img; modalFlipBtn.style.display='none'; }
}
function flipLeader(e) {
    if(e) e.stopPropagation();
    if(!currentZoomCard || currentZoomCard.type !== 'Leader') return;
    const isBack = modalImg.src.includes("face=true") || modalImg.src.includes("-back"); 
    modalImg.src = isBack ? currentZoomCard.img : currentZoomCard.back;
}
function closeModal() { modal.style.display='none'; }
function copyJSON() { 
    const d={metadata:{name:"Sealed",author:"SWU"},leader:null,base:null,deck:[],sideboard:[]};
    Object.values(myDeck).forEach(c=>{ const e={id:`${c.set}_${c.id}`,count:c.count}; if(c.type==='Leader') d.leader=e; else if(c.type==='Base') d.base=e; else d.deck.push(e); });
    const el=document.createElement('textarea'); el.value=JSON.stringify(d,null,2); document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); playAudio('snd-copy'); 
    document.getElementById('toast').className = 'show'; setTimeout(()=>document.getElementById('toast').className='', 2000);
}

window.onload = function() { initBoard(); };
</script>
</body>
</html>
